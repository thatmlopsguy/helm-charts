{{- range $name, $deployment := .Values.deployments }}
{{- if and $deployment.externalSecret $deployment.externalSecret.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "global.fullname" $ }}-{{ $name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "global.labels" $ | nindent 4 }}
    app.kubernetes.io/component: {{ $name }}
  {{- with $deployment.externalSecret.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if $deployment.externalSecret.refreshInterval }}
  refreshInterval: {{ $deployment.externalSecret.refreshInterval }}
  {{- else }}
  refreshInterval: "15m"
  {{- end }}
  secretStoreRef:
    name: {{ $deployment.externalSecret.secretStoreRef.name }}
    kind: {{ $deployment.externalSecret.secretStoreRef.kind | default "SecretStore" }}
  target:
    name: {{ $deployment.externalSecret.target.name | default (printf "%s-%s" (include "global.fullname" $) $name) }}
    creationPolicy: {{ $deployment.externalSecret.target.creationPolicy | default "Owner" }}
    {{- if $deployment.externalSecret.target.deletionPolicy }}
    deletionPolicy: {{ $deployment.externalSecret.target.deletionPolicy }}
    {{- end }}
    {{- if $deployment.externalSecret.target.template }}
    template:
      {{- with $deployment.externalSecret.target.template.type }}
      type: {{ . }}
      {{- end }}
      {{- with $deployment.externalSecret.target.template.metadata }}
      metadata:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $deployment.externalSecret.target.template.data }}
      data:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    {{- end }}
  {{- if $deployment.externalSecret.data }}
  data:
    {{- toYaml $deployment.externalSecret.data | nindent 4 }}
  {{- end }}
  {{- if $deployment.externalSecret.dataFrom }}
  dataFrom:
    {{- toYaml $deployment.externalSecret.dataFrom | nindent 4 }}
  {{- end }}
{{- end }}
{{- end }}

{{/*
Support for global ExternalSecrets that are shared across deployments
*/}}
{{- if and .Values.externalSecrets .Values.externalSecrets.enabled }}
{{- range $name, $externalSecret := .Values.externalSecrets.secrets }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "global.fullname" $ }}-{{ $name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "global.labels" $ | nindent 4 }}
    app.kubernetes.io/component: shared
  {{- with $externalSecret.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if $externalSecret.refreshInterval }}
  refreshInterval: {{ $externalSecret.refreshInterval }}
  {{- else }}
  refreshInterval: "15m"
  {{- end }}
  secretStoreRef:
    name: {{ $externalSecret.secretStoreRef.name }}
    kind: {{ $externalSecret.secretStoreRef.kind | default "SecretStore" }}
  target:
    name: {{ $externalSecret.target.name | default (printf "%s-%s" (include "global.fullname" $) $name) }}
    creationPolicy: {{ $externalSecret.target.creationPolicy | default "Owner" }}
    {{- if $externalSecret.target.deletionPolicy }}
    deletionPolicy: {{ $externalSecret.target.deletionPolicy }}
    {{- end }}
    {{- if $externalSecret.target.template }}
    template:
      {{- with $externalSecret.target.template.type }}
      type: {{ . }}
      {{- end }}
      {{- with $externalSecret.target.template.metadata }}
      metadata:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $externalSecret.target.template.data }}
      data:
        {{- toYaml . | nindent 8 }}
      {{- end }}
    {{- end }}
  {{- if $externalSecret.data }}
  data:
    {{- toYaml $externalSecret.data | nindent 4 }}
  {{- end }}
  {{- if $externalSecret.dataFrom }}
  dataFrom:
    {{- toYaml $externalSecret.dataFrom | nindent 4 }}
  {{- end }}
{{- end }}
{{- end }}
